<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我的位置</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.1.0/paho-mqtt.min.js"></script>
    <script src='https://webapi.amap.com/maps?v=2.0&key=47d57deacf67daf4fe68b31c3dcdc253'></script>
    <style>
        html,
        body,
        #container {
            margin: 0;
            height: 100%;
        }

        #mdd {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 200;
        }

        #shijian {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            z-index: 200;
        }
    </style>
</head>

<body>
    <div id='container'>加载中...</div>
    <input type="button" value="开始连接..." id="mdd" onclick="Chongxinguihua()">
    <input type="button" value="版本14" id="shijian">

</body>
<script>
    // let mdd = document.getElementById("mdd");
    let map;
    let myico;

    let MQTT = new Paho.Client('bemfa.com', 9504, '/wss', '6a685d7b4d7f45a1bf5540e21a08e69c');
    MQTT.onConnected = () => mdd.value += '连接成功';
    MQTT.onConnectionLost = (m) => mdd.value = '连接断开 ' + m.errorMessage;
    MQTT.onMessageArrived = onMessageArrived;//收到消息时
    MQTT.connect({
        "useSSL": true,
        "onSuccess": () => {//连接确认时
            MQTT.subscribe('ren', {//订阅主题
                "onSuccess": () => mdd.value += '订阅ren成功',
                "onFailure": () => mdd.value = '订阅失败'
            });
            MQTT.subscribe('car', {//订阅主题
                "onSuccess": () => mdd.value += '订阅car成功',
                "onFailure": () => mdd.value = '订阅失败'
            });
        },
        "onFailure": () => mdd.value = '连接失败',//连接请求失败或超时
        "reconnect": true //连接丢失时会尝试重新连接
    });



    function onMessageArrived(m) {//收到消息
        console.log(m.topic);
        console.log(JSON.parse(m.payloadString));
        if (m.topic === 'car') {//收到车辆位置

        } else {//收到人员位置

        }
        mdd.value = "收到消息：" + JSON.parse(m.payloadString).a;


        // let message = new Paho.Message("Hello");
        // message.destinationName = "ren";
        // console.log(message);
        // MQTT.send(message);
    }






    //首次进入页面，载入最后1个位置
    fetch('https://apis.bemfa.com/va/getmsg?uid=6a685d7b4d7f45a1bf5540e21a08e69c&topic=car&type=1')
        .then(res => res.json())
        .then(res => {
            d = JSON.parse(res.data[0].msg)
            //显示地图
            mdd.value += d.a
            map = new AMap.Map("container", {
                zoom: 18,
                center: d.a
            });
            //显示小车
            AMap.plugin('AMap.MoveAnimation', function () {
                marker = new AMap.Marker({
                    map: map,
                    position: d.a,
                    icon: "https://27315.app/y/0.png",
                    offset: new AMap.Pixel(-12, -24)
                });
            });
            //显示控件
            KongJian()
        })

    //以下控件
    function KongJian() {
        //放大缩小控件
        AMap.plugin("AMap.ToolBar", function () {
            map.addControl(new AMap.ToolBar({
                "position": "LB",
                "offset": [10, 50]
            }));
        });
        //放大缩小控件结束
        //定位控件
        AMap.plugin("AMap.Geolocation", function () {
            geolocation = new AMap.Geolocation({
                offset: [10, 50],//按钮偏移量
                convert: true,//转高德坐标
                position: 'RB',//定位按钮的位置
                panToLocation: false,//定位成功后不要作为地图中心点
                enableHighAccuracy: true //高精度定位
            })
            //显示定位按钮
            map.addControl(geolocation);
            //定位成功时
            geolocation.on('complete', function (m) {

                if (myico) {//已有图标
                    console.log('已有图标')
                    console.log(m)

                    myico.moveTo([m.position.lng, m.position.lat], {
                        duration: 1000,
                        autoRotation: false//不旋转
                    });
                } else {//没有图标
                    console.log('没有图标')
                    let names = ["宝玉", "曹操", "超人", "妲己", "黛玉", "貂蝉", "段誉", "关羽", "杰瑞", "柯南", "刘备", "路飞", "洛基", "吕布", "麦兜", "玫瑰", "灭霸", "鸣人", "哪吒", "佩琪", "乔治", "沙僧", "孙权", "汤姆", "唐僧", "悟空", "星爵", "虚竹", "杨过", "鹰眼", "张飞", "赵云", "周瑜", "阿童木", "奥特曼", "白素贞", "白云生", "蝙蝠侠", "步惊云", "楚留香", "风清扬", "钢铁侠", "格鲁特", "红太狼", "胡一刀", "花满楼", "花木兰", "花无缺", "灰太狼", "机器猫", "加菲猫", "金刚狼", "蓝精灵", "懒洋洋", "李寻欢", "梁山伯", "林诗音", "令狐冲", "柳余恨", "鲁智深", "绿巨人", "美人鱼", "美羊羊", "米老鼠", "木婉清", "皮卡丘", "皮皮鲁", "秋凤梧", "任我行", "软绵绵", "闪电侠", "沈璧君", "圣斗士", "史努比", "水灵光", "孙悟空", "唐老鸭", "韦小宝", "喜羊羊", "向问天", "萧别离", "小龙女", "小王子", "小燕子", "燕南天", "叶孤城", "原随云", "张无忌", "蜘蛛侠", "诸葛亮", "猪八戒", "祝英台", "超级飞侠", "东方不败", "独孤求败", "独孤一鹤", "哆啦A梦", "火箭浣熊", "蜡笔小新", "雷神托尔", "慕容秋水", "奇异博士", "神奇女侠", "司空摘星", "西门吹雪", "萧十一郎", "飞天小女警", "美少女战士"];
                    let i = Math.floor(Math.random() * names.length);
                    let myid = names[i];
                    AMap.plugin('AMap.MoveAnimation', function () {
                        myico = new AMap.Marker({
                            map: map,
                            position: m.position,
                            label: {
                                content: myid,
                                direction: top
                            }
                        })
                    })
                    map.setFitView();//自适应显示全部
                    setInterval(() => {
                        geolocation.getCurrentPosition();//再次定位
                    }, 5000);
                }
            })
        })//定位控件结束


    }
</script>

</html>